# To be printed as markdown on the "Advanced Options" page. 
# ---------------------------------------------------------------------

# Advanced options

Perhaps this page could allow the user to upload their own file, and then a result could be calculated. 

There are lots of things that Streamlit can do. [Have a look here for ideas](https://docs.streamlit.io/library/api-reference).


# Find a better home for the following:

## Mortality calculations

### Mortality models

Why two mortality models are used (from Methods in the paper):
> _"Increased mortality risk in the 12months following discharge followed by lower risks in subsequent years means they are unsuitable for use during this period as the hazard of death potentially decreases."_

+ Logistic model: 
$$ 
P_1 = \frac{1}{1+e^{-LP_{\mathrm{12mo}}}} 
$$
with linear predictor 
$$ 
  LP_{\mathrm{12mo}} = 
    \alpha_{\mathrm{12mo}} +
    \displaystyle\sum_{i=1}^{n} 
      \beta_{\mathrm{12mo},\ i} 
      \cdot 
      X_{\mathrm{12mo},\ i} 
$$ 
$P_{\mathrm{within\ 12mo}}$ or mortality within twelve months of discharge. 

There is no factor of time in the logistic model. The probability is constant throughout that first year. 

+ Gompertz model: 
$$ 
H_t = \frac{e^{LP_{\mathrm{H}}}(e^{\gamma t} - 1)}{\gamma} 
$$
with linear predictor 
$$ 
  LP_{\mathrm{H}} = 
    \alpha_{\mathrm{H}} + 
    \displaystyle\sum_{i=1}^{n} 
    \beta_{\mathrm{H},\ i} 
    \cdot
    X_{\mathrm{H},\ i} 
$$ 
Mortality after twelve months of discharge. 

Both of these use separate linear estimators $\alpha+\displaystyle\sum_{i=1}^{n} \beta_i X_i$. This syntax is the inner product, from the multiplication of two 1D vectors: 
$$ <A,B> = \displaystyle\sum_{i=1}^{n} A_i B_i $$
The logistic model uses $n=8$ factors and the Gompertz model uses $n=14$. $A$ is a vector containing coefficients, and $B$ contains matching values for the chosen patient. 
The coefficients are contained in one of the Excel sheets. 
The first value of $B$ is just 1, so that the first value of $A$ is the constant $\alpha$ in the formula. 


The mortality at $t$ years after admission is: 

$$ P_{\mathrm{chosen\ time}} = 1 - e^{(H_{t-1} - H_{t})} $$
_Unless_ the earlier year is the first year, in which case:

$$ P_{\mathrm{chosen\ time}} = 1 - e^{(P_{\mathrm{within\ 12mo}} - H_{t})} $$
 

### Life expectancy

The resulting probabilities of death can be thrown into the same formula for calculating the expected lifespan in years. 

If $P_{\mathrm{chosen\ time}}$ < $P_{\mathrm{within\ 12mo}}$, the expectancy is:

$$ t_{\mathrm{years}} = \frac{\log{(P_{\mathrm{chosen\ time}})}}{\frac{1}{365}\log{(1-P_{\mathrm{within\ 12mo}})}} \cdot \frac{1}{365} $$

This doesn't look correct. 

Or, if the $P_{\mathrm{chosen\ time}}$ $\geq$ $P_{\mathrm{within\ 12mo}}$:

1. Define some scaled probability:
$$ P' = \frac{ 1+P_{\mathrm{chosen\ time}} }{ 1+P_{\mathrm{within\ 12mo}} } - 1 $$ 
2. Then calculate the Gompertz linear predictor, $LP_G$, as normal.
3. The expectancy in days is:
$$ t_{\mathrm{days}} = \frac{1}{\gamma} \left\[ \log{(\gamma \cdot P' \cdot e^{-LP_G})} + 1\right\] $$
4. And conversion to years:
$$ t_{\mathrm{years}} = \frac{1}{365}t_{\mathrm{days}} + 1$$

Notes:
+ _"Lifespan was truncated at 100 years of age"_.



## Resource use

For each mRS, the number of each of the following can be calculated:
+ A&E admissions
+ NEL bed days
+ EL bed days 
+ Residential care 

These are calculated separately for discounted and undiscounted. (Whatever they are??)



### Resource use models

For a given individual and a number of years, the total number of A&E admissions, elective bed days, and non-elective bed days can be calculated.

The method is broadly similar for each (comments from the R code):
  1. _"calculates the normalized age"_
  2. _"calculates the linear predictor for EL bed days"_
  3. _"creates the lambda function for the equation"_
  4. _"equation that estimates the EL bed days count"_
  
And each of the three models uses a separate set of coefficients (constant, age, sex, gamma) and a different weight for each mRS.

> One of these variables is called "gamma". Is it related to the gamma for the Gompertz mortality function? 

+ A&E admissions model:
$$ 
\mathrm{Count} = 
  \exp{( 
    \gamma_{\mathrm{AE}} \times LP_{\mathrm{AE}}
    \times 
    \mathrm{yrs} ^{\gamma_{\mathrm{AE}}}
  )}
$$
Weibull distribution.


+ Elective bed days model:
$$ 
  \mathrm{Count} = 
    -\log{\left( 
      \frac{1}{
        1+ [\mathrm{yrs}*\exp{(-LP_\mathrm{EL})} ] ^{1/ \gamma_{\mathrm{EL}}} 
      }
    \right)}
$$
Log-logistic distribution.

+ Non-elective bed days model:
$$ 
  \mathrm{Count} = 
    -\log{\left( 
      \frac{1}{
        1+ [\mathrm{yrs}*\exp{(-LP_\mathrm{NEL})} ] ^{1/ \gamma_{\mathrm{NEL}}} 
      }
    \right)}
$$
Log-logistic distribution. 

Then the calculated numbers of days are multiplied by the cost of each day or cost of each trip to A&E to give the total cost of resource use. 

Notes: 
+ Log-logistic function = log of a logistic distribution. 
